## 概要
jpegなどの画像圧縮処理を元に、VRChat(SDK3)上で動作する非可逆の圧縮/展開処理を実装しました<br>
また、圧縮した結果をUdonで読み込み、同期変数によりLateJoinerや他の人に同期、同期された値を展開する処理を実装しました<br>

圧縮/展開はほぼ全てShaderで実装されており、それぞれCustomRenderTextureの1Updateで動作するようにしています<br>
ただし、環境によりますが1回の処理で1000ms以上必要です<br>
<br>
512pxx512px RGBA32の画像を圧縮Lv2（デフォルト）で30kbyte程度に圧縮できるため、おそらく1度の同期変数によって同期が可能です（複数や他に重い同期物がある場合は不可）<br>

技術サンプルです、**使用は自己責任でお願いいたします**<br>
（ライセンス他でなにか問題ありそうでしたらご指摘ください）

## 圧縮の仕様
RGBA32を圧縮できます（アルファ値も圧縮できます）<br>
圧縮の際、YCbCr + Aに変換され、CbCrは縦横1/2の解像度に変換されます（4:1:1,4(alpha)）<br>
圧縮率は1～10程度で設定でき、圧縮率によってサイズ・処理時間が変わります（デフォルトは2）<br>
<br>
おそらく圧縮率を下げる(値を大きくする)方が遅くなります<br>
<br>
サンプルとして内部で使用している各種値は以下のサイトなどを参考にしています<br>
https://www.w3.org/Graphics/JPEG/

## 全体の処理の流れ
#### 圧縮
Udonから、ImageCompressCbCr / ImageCompressYA の CRTのUpdateを呼ぶ<br>
各CRTでは、Update Zoneを複数指定することで、1Updateで以下の処理をまとめて行う

##### 1. 前処理
入力のRenderTextureをRGBA32からY/AとCbCrに変換、0-1の値を0-255に変換

##### 2. 離散コサイン変換
各ブロックごとに周波数成分に変換

##### 3. 並び替え
各ブロックの周波数成分をジグザグに走査して一列に並べる

##### 4. 差分計算
各ブロックのDC成分を前のブロックとの差分を取るように（一定間隔でリセットする）

##### 5.ハフマン符号化
対象のピクセルに到達するまで、先頭から順にハフマン符号化を行い、到達したところで該当のデータを詰める<br>
R8G8の範囲のデータになるようにする

##### 6.総数の算出(1)
画像末尾から走査し、それぞれ(Y,A、またはCb,Cr)のデータサイズを1ピクセル目に保存する

##### 7.データを寄せる
Udonでは、配列走査を行うととても遅いため、配列コピーのみを行いたい<br>
そこで、<br>
(R0,G0),(R1,G1),(R2,G2),(R3,G3),(R4,G4),…<br>
と並んでいるデータを<br>
(R0,R1,R2,R3),(R4,0,0,0),(G0,G1,G2,G3),(G4,0,0,0)<br>
となるように並べ直す

##### 8.総数の算出(2)
画像末尾から走査し、色が(0,0,0,0)でない箇所までのデータサイズを1ピクセル目に保存する

#### 展開
上記圧縮と逆の手順で展開する

#### Udonでの処理
Y/A、CbCrの画像を上下に並べてまとめてカメラで撮影<br>
それぞれをUdonで事前に用意したTexture2Dに書き込む<br>
（この時、Y/A、CbCrの画像はアルファ値もカメラで読み込めるように専用のシェーダーを使用する）<br>
<br>
各Texture2DをRGBA32の配列として読み込む<br>
1px目を見てサイズを取得、そのサイズの送信用の配列を新たに用意、そのサイズ分だけコピーする<br>
（この時、実際に容量が削減される）<br>
<br>
受け取り側はTexture2Dに上記データを書き込み、展開処理を行う
